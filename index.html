<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Turbo GP by Sanchalit Games is an exciting racing game with customizable cars, mobile controls, and competitive leaderboards.">
    <meta name="keywords" content="Turbo GP, racing game, Sanchalit Games, mobile racing, car game, browser game">
    <meta name="author" content="Sanchalit Games">
    <meta property="og:title" content="Turbo GP - Racing Game by Sanchalit Games">
    <meta property="og:description" content="Race in Turbo GP, a thrilling browser-based racing game by Sanchalit Games with customizable cars and leaderboards.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://turbo-gp.sanchalitgames.com">
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "VideoGame",
        "name": "Turbo GP",
        "description": "Turbo GP by Sanchalit Games is a fast-paced racing game where players customize cars, race on a dynamic track, and compete for the fastest lap times on a global leaderboard.",
        "genre": "Racing",
        "platform": "Web",
        "publisher": {
            "@type": "Organization",
            "name": "Sanchalit Games"
        }
    }
    </script>
    <title>Turbo GP - Racing Game by Sanchalit Games</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #34495e;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            color: white;
            font-family: 'Press Start 2P', cursive;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            touch-action: none;
        }

        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #gameCanvas {
            background-color: #1e8449;
            width: 100%;
            height: 100%;
        }

        #ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .screen {
            pointer-events: all;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid white;
            animation: fadeIn 0.5s ease-in-out;
            max-width: 95%;
            box-sizing: border-box;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        #instructions-screen {
            z-index: 100;
        }

        .screen h1, .screen h2 {
            font-size: 1.8em;
            text-shadow: 2px 2px #c0392b;
        }
        
        #instruction-text {
            line-height: 1.5;
            font-size: 0.9em;
            margin-bottom: 20px;
        }
        
        #instructions-screen p b {
            font-size: 1.1em;
            color: #2ecc71;
        }

        #desktop-site-message, #disclaimer-text {
            font-size: 0.8em;
            color: #f1c40f;
            margin-top: 15px;
        }

        @media (max-width: 767px) {
            #instructions-screen {
                padding: 15px;
            }
            #instruction-text {
                font-size: 0.9em;
                max-height: 70vh;
                overflow-y: auto;
            }
            #instruction-text p {
                margin: 8px 0;
            }
            #instruction-text b {
                font-weight: bold;
            }
            #instruction-text::-webkit-scrollbar {
                width: 6px;
            }
            #instruction-text::-webkit-scrollbar-thumb {
                background-color: rgba(255, 255, 255, 0.5);
                border-radius: 3px;
            }
            #instruction-text::-webkit-scrollbar-track {
                background-color: transparent;
            }
            .screen h1, .screen h2 {
                font-size: 1.8em;
            }
            #customization-screen {
                padding: 15px;
                max-height: 70vh;
                overflow-y: auto;
            }
            #customization-screen::-webkit-scrollbar {
                width: 6px;
            }
            #customization-screen::-webkit-scrollbar-thumb {
                background-color: rgba(255, 255, 255, 0.5);
                border-radius: 3px;
            }
            #customization-screen::-webkit-scrollbar-track {
                background-color: transparent;
            }
            #customization-screen .car-preview {
                width: 120px;
                height: 120px;
            }
            #disclaimer-text {
                font-size: 0.7em;
                max-width: 90%;
            }
        }

        input[type="text"], input[type="range"] {
            padding: 10px;
            font-size: 1em;
            border: 2px solid white;
            border-radius: 5px;
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            text-align: center;
            outline: none;
            width: 80%;
            max-width: 200px;
            margin-top: 10px;
            touch-action: manipulation;
        }

        @media (max-width: 767px) {
            input[type="text"], input[type="range"] {
                width: 70%;
                max-width: 180px;
            }
        }
        
        .error-message {
            color: #e74c3c;
            font-size: 0.8em;
            margin-top: 10px;
        }

        #message-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 20px 40px;
            border-radius: 10px;
            border: 2px solid white;
            animation: fadeInOut 2s forwards;
            font-size: 1.5em;
            text-shadow: 2px 2px #2ecc71;
            white-space: nowrap;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
            10% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            90% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1.1); }
        }
        
        #customization-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        #customization-screen .car-preview {
            width: 150px;
            height: 150px;
            margin-bottom: 15px;
            background-color: transparent;
        }

        button {
            padding: 20px 40px;
            font-size: 1.2em;
            border: none;
            border-radius: 8px;
            background-color: #2ecc71;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
            margin-top: 20px;
            touch-action: manipulation;
            pointer-events: auto;
        }

        @media (max-width: 767px) {
            button {
                padding: 15px 30px;
                font-size: 1em;
            }
        }

        button:hover {
            background-color: #27ae60;
            transform: translateY(-2px);
        }
        
        button:active {
            transform: translateY(0);
        }

        .clear-leaderboard-button {
            background-color: #e74c3c;
        }

        .clear-leaderboard-button:hover {
            background-color: #c0392b;
        }

        .hidden {
            display: none !important;
        }

        #hud {
            position: absolute;
            top: 10px;
            width: 90%;
            display: flex;
            flex-direction: column;
            pointer-events: none;
        }

        #top-hud {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
            width: 100%;
        }

        #hud-left, #hud-right {
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 5px;
        }
        
        #mobile-controls {
            display: none;
            position: absolute;
            bottom: 40px;
            width: 100%;
            pointer-events: all;
            padding: 0 30px;
            box-sizing: border-box;
            justify-content: space-between;
        }
        
        .mobile-buttons {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .mobile-buttons button {
            width: 140px;
            height: 140px;
            margin: 0;
            font-size: 3.5em;
            background-color: rgba(52, 152, 219, 0.8);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
            transition: transform 0.1s, box-shadow 0.1s;
            touch-action: manipulation;
        }

        .mobile-buttons button:active {
            transform: scale(0.9);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.6);
        }

        .arrow-indicator {
            position: absolute;
            font-size: 4em;
            color: rgba(255, 255, 255, 0.8);
            pointer-events: none;
            animation: fadeArrow 2.5s ease-in-out;
        }

        @keyframes fadeArrow {
            0% { opacity: 0; transform: translateY(15px); }
            20% { opacity: 1; transform: translateY(0); }
            80% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-15px); }
        }
        
        #steer-left-arrow { bottom: 180px; left: 30px; }
        #steer-right-arrow { bottom: 40px; left: 30px; }
        #accel-arrow { bottom: 180px; right: 30px; }
        #brake-arrow { bottom: 40px; right: 30px; }
        
        .car-style-selector {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        @media (max-width: 767px) {
            .car-style-selector {
                gap: 10px;
            }
        }

        #leaderboard {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid white;
            text-align: center;
            z-index: 10;
            pointer-events: all;
        }
        
        #leaderboard li {
            padding: 5px 0;
        }

        #leaderboard li.gold {
            color: #FFD700;
            text-shadow: 1px 1px #B8860B;
        }

        #leaderboard li.silver {
            color: #C0C0C0;
            text-shadow: 1px 1px #808080;
        }

        #leaderboard li.bronze {
            color: #CD7F32;
            text-shadow: 1px 1px #8B4513;
        }

        #leaderboard li.blue {
            color: #3498DB;
            text-shadow: 1px 1px #2980B9;
        }

        #leaderboard li.current-player {
            background-color: rgba(46, 204, 113, 0.3);
        }
        
        .car-style-button {
            padding: 10px 20px;
            font-size: 0.8em;
            border-radius: 20px;
            background-color: #3498db;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
            touch-action: manipulation;
        }

        @media (max-width: 767px) {
            .car-style-button {
                padding: 8px 16px;
                font-size: 0.7em;
            }
        }
        
        .car-style-button.active {
            background-color: #2980b9;
        }

        .sensitivity-container, .volume-container {
            margin-top: 20px;
            width: 80%;
            max-width: 250px;
            text-align: left;
        }

        .sensitivity-bar {
            width: 100%;
            height: 10px;
            background-color: #444;
            border-radius: 5px;
            margin-top: 5px;
            position: relative;
        }

        .sensitivity-bar-fill {
            height: 100%;
            background-color: #2ecc71;
            border-radius: 5px;
            transition: width 0.2s ease-in-out;
        }

        @media (max-width: 767px) {
            .sensitivity-container, .volume-container {
                max-width: 200px;
            }
            .sensitivity-container label, .volume-container label {
                font-size: 0.8em;
            }
            #sensitivity-value, #volume-value {
                font-size: 0.7em;
            }
        }

        .sensitivity-container label, .volume-container label {
            font-size: 0.9em;
            margin-bottom: 5px;
            display: block;
        }

        #sensitivity-value, #volume-value {
            font-size: 0.8em;
            color: #2ecc71;
        }

        .buttons-container {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        @media (min-width: 768px) {
            #mobile-controls {
                display: none !important;
            }
            #desktop-site-message {
                display: none;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes flash {
            0% { background-color: rgba(255, 255, 255, 0); }
            50% { background-color: rgba(255, 255, 255, 0.3); }
            100% { background-color: rgba(255, 255, 255, 0); }
        }

        .flash-effect {
            animation: flash 0.3s ease-in-out;
        }

        #fullscreen-button {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            font-size: 0.8em;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            display: none;
        }

        @media (max-width: 767px) {
            #fullscreen-button {
                display: block;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        <div id="ui-overlay">
            <div id="splash-screen" class="screen">
                <h1>Turbo GP by Sanchalit Games</h1>
                <p id="disclaimer-text">Turbo GP is in active development! We’re working hard to improve the game and will soon add new tracks, cars, and more exciting features. Stay tuned!</p>
                <button id="enterGameButton">Enter Game</button>
            </div>
            <div id="instructions-screen" class="screen hidden">
                <h1>Turbo GP</h1>
                <div id="instruction-text">
                    <p>Welcome, Racer! On mobile, control your car with on-screen buttons.</p>
                    <p><b>Left Side</b>: Tap <b>Left</b> to steer left, <b>Right</b> to steer right.</p>
                    <p><b>Right Side</b>: Tap <b>Gas</b> to accelerate, <b>Brake</b> to brake.</p>
                    <p><b>Boost</b>: Tap the screen with <b>two fingers</b> for a speed boost (when ready)!</p>
                    <p>Follow the <b>green arrow</b> to hit checkpoints and complete the lap!</p>
                    <p>Tip: Adjust steering sensitivity and engine volume in customization.</p>
                    <p id="desktop-site-message">For the best experience, enable desktop site mode on your browser!</p>
                </div>
                <button id="nextToUsernameButton">Got it!</button>
            </div>
            
            <div id="username-screen" class="screen hidden">
                <h1>Enter Username</h1>
                <p>Enter a unique username (8–16 characters) to join the race.</p>
                <input type="text" id="usernameInput" placeholder="Username">
                <div id="username-error-message" class="error-message hidden"></div>
                <button id="saveUsernameButton">Save & Continue</button>
            </div>

            <div id="customization-screen" class="screen hidden">
                <h1>Customize Your Car</h1>
                <canvas id="carPreviewCanvas" class="car-preview"></canvas>
                <div class="car-style-selector">
                    <button class="car-style-button active" data-style="sedan">Sedan</button>
                    <button class="car-style-button" data-style="pickup">Pickup</button>
                    <button class="car-style-button" data-style="sports">Sports Car</button>
                    <button class="car-style-button" data-style="porsche">Porsche</button>
                </div>
                <div class="sensitivity-container">
                    <label for="steeringSensitivity">Steering Sensitivity: <span id="sensitivity-value">1.0</span></label>
                    <input type="range" id="steeringSensitivity" min="0.1" max="4.0" step="0.05" value="1.0">
                    <div class="sensitivity-bar">
                        <div class="sensitivity-bar-fill" id="sensitivity-bar-fill"></div>
                    </div>
                </div>
                <div class="volume-container">
                    <label for="engineVolume">Engine Volume: <span id="volume-value">50</span>%</label>
                    <input type="range" id="engineVolume" min="0" max="100" step="1" value="50">
                </div>
                <button id="startButton">Start Race!</button>
            </div>
            
            <div id="hud" class="hidden">
                <div id="top-hud">
                    <div id="hud-left">
                        <p>LAP: <span id="lapCount">0/1</span></p>
                        <p>TIME: <span id="lapTime">00:00.000</span></p>
                    </div>
                    <div id="hud-right">
                        <p>SPEED: <span id="speedDisplay">0</span> km/h</p>
                        <p>BOOST: <span id="boostDisplay">Ready</span></p>
                    </div>
                </div>
            </div>

            <div id="message-display" class="hidden"></div>
            
            <div id="leaderboard" class="screen hidden">
                <h2>Top 10 Lap Times</h2>
                <p id="player-best-time" class="hidden"></p>
                <p>Note: PC users compete with PC users, and mobile users compete with mobile users.</p>
                <ol id="leaderboard-list"></ol>
                <div class="buttons-container">
                    <button id="retryButton">Retry</button>
                    <button id="checkLeaderboardButton">Back to Menu</button>
                    <button id="clearLeaderboardButton" class="clear-leaderboard-button">Clear Leaderboard</button>
                </div>
            </div>
        </div>

        <div id="mobile-controls">
            <div class="mobile-buttons" id="steering-controls">
                <button id="steerLeft">Left</button>
                <button id="steerRight">Right</button>
                <div id="steer-left-arrow" class="arrow-indicator hidden">Left</div>
                <div id="steer-right-arrow" class="arrow-indicator hidden">Right</div>
            </div>
            <div class="mobile-buttons" id="speed-controls">
                <button id="accelButton">Gas</button>
                <button id="brakeButton">Brake</button>
                <div id="accel-arrow" class="arrow-indicator hidden">Gas</div>
                <div id="brake-arrow" class="arrow-indicator hidden">Brake</div>
            </div>
        </div>
        <button id="fullscreen-button" onclick="enterFullscreen()">Fullscreen</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script>
        'use strict';

        // --- Game State and Constants ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d', { alpha: false });
        let gameActive = false;
        let currentPlayerName = '';
        
        let car = {
            x: 0,
            y: 0,
            angle: 0,
            speed: 0,
            style: 'sedan',
            isBoosting: false,
            boostTimer: 0,
            boostCooldown: 0,
            lapTimes: [],
            steeringSensitivity: 1.0
        };
        
        const totalLaps = 1;
        let currentLap = 0;
        let checkpointIndex = 0;
        let lapStartTime = null;
        let lastTimestamp = 0;
        let animationFrameId;
        let flashTimer = 0;
        let boostTrail = [];
        let trackPath = [];
        let checkpoints = [];
        
        const keys = {};
        const mobileControls = {
            accel: false,
            brake: false,
            left: false,
            right: false
        };

        const config = {
            acceleration: 0.25, // Increased from 0.18
            friction: 0.98,
            maxSpeed: 16, // Increased from 12
            boostSpeed: 24, // Increased from 18
            baseRotationSpeed: 0.018,
            boostDuration: 2000,
            boostCooldown: 8000,
            carWidth: 50,
            carHeight: 100,
            trackWidth: 150,
            trackPoints: 500,
            cameraShakeDuration: 200,
            cameraShakeIntensity: 5,
            arrowSize: 30,
            flashDuration: 300,
            boostTrailLength: 20,
            maxTireMarks: 200
        };
        
        let camera = { x: 0, y: 0, shakeTime: 0 };
        const tireMarks = [];
        let engineSynth;
        let skidSynth;
        let boostSynth;
        let clickSynth;
        let checkpointSynth;
        let lapCompleteSynth;
        let engineVolume = parseInt(localStorage.getItem('turboGPEngineVolume')) || 50;
        const isMobile = window.innerWidth < 768 || /Mobi|Android/i.test(navigator.userAgent);
        const leaderboardKey = isMobile ? 'turboGPLeaderboardMobile' : 'turboGPLeaderboardPC';
        const particles = [];

        // Car images
        const carImages = {
            sedan: new Image(),
            pickup: new Image(),
            sports: new Image(),
            porsche: new Image()
        };
        carImages.sedan.src = 'https://opengameart.org/sites/default/files/styles/medium/public/TRBRYcars-%5BConverted%5D-sedan.png';
        carImages.pickup.src = 'https://opengameart.org/sites/default/files/styles/medium/public/TRBRYcars-%5BConverted%5D-pickup.png';
        carImages.sports.src = 'https://opengameart.org/sites/default/files/styles/medium/public/car1_spr_0.png';
        carImages.porsche.src = 'https://opengameart.org/sites/default/files/styles/medium/public/Porsche%20911%20Carrera%201998.png';

        // --- DOM Elements ---
        const splashScreen = document.getElementById('splash-screen');
        const enterGameButton = document.getElementById('enterGameButton');
        const instructionsScreen = document.getElementById('instructions-screen');
        const nextToUsernameButton = document.getElementById('nextToUsernameButton');
        const usernameScreen = document.getElementById('username-screen');
        const usernameInput = document.getElementById('usernameInput');
        const saveUsernameButton = document.getElementById('saveUsernameButton');
        const usernameError = document.getElementById('username-error-message');
        const customizationScreen = document.getElementById('customization-screen');
        const hud = document.getElementById('hud');
        const startButton = document.getElementById('startButton');
        const messageDisplay = document.getElementById('message-display');
        const lapCountDisplay = document.getElementById('lapCount');
        const lapTimeDisplay = document.getElementById('lapTime');
        const speedDisplay = document.getElementById('speedDisplay');
        const boostDisplay = document.getElementById('boostDisplay');
        const carStyleButtons = document.querySelectorAll('.car-style-button');
        const carPreviewCanvas = document.getElementById('carPreviewCanvas');
        const carPreviewCtx = carPreviewCanvas.getContext('2d');
        const leaderboard = document.getElementById('leaderboard');
        const leaderboardList = document.getElementById('leaderboard-list');
        const retryButton = document.getElementById('retryButton');
        const checkLeaderboardButton = document.getElementById('checkLeaderboardButton');
        const clearLeaderboardButton = document.getElementById('clearLeaderboardButton');
        const playerBestTimeDisplay = document.getElementById('player-best-time');
        const steeringSensitivityInput = document.getElementById('steeringSensitivity');
        const sensitivityValueDisplay = document.getElementById('sensitivity-value');
        const sensitivityBarFill = document.getElementById('sensitivity-bar-fill');
        const engineVolumeInput = document.getElementById('engineVolume');
        const volumeValueDisplay = document.getElementById('volume-value');
        const steerLeftArrow = document.getElementById('steer-left-arrow');
        const steerRightArrow = document.getElementById('steer-right-arrow');
        const accelArrow = document.getElementById('accel-arrow');
        const brakeArrow = document.getElementById('brake-arrow');
        const mobileControlsDiv = document.getElementById('mobile-controls');

        // --- Helper Functions ---
        function lerp(start, end, amt) {
            return start * (1 - amt) + end * amt;
        }

        function formatTime(ms) {
            const minutes = Math.floor(ms / 60000);
            const seconds = Math.floor((ms % 60000) / 1000);
            const milliseconds = Math.floor(ms % 1000);
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${String(milliseconds).padStart(3, '0')}`;
        }
        
        function showMessage(text) {
            messageDisplay.textContent = text;
            messageDisplay.classList.remove('hidden');
            clearTimeout(messageDisplay.timer);
            messageDisplay.timer = setTimeout(() => {
                messageDisplay.classList.add('hidden');
            }, 2000);
        }

        function triggerCameraShake() {
            camera.shakeTime = config.cameraShakeDuration;
        }

        function triggerFlash() {
            flashTimer = config.flashDuration;
            canvas.classList.add('flash-effect');
            setTimeout(() => canvas.classList.remove('flash-effect'), config.flashDuration);
        }

        function getDistance(x1, y1, x2, y2) {
            return Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
        }

        function showArrowIndicators() {
            steerLeftArrow.classList.remove('hidden');
            steerRightArrow.classList.remove('hidden');
            accelArrow.classList.remove('hidden');
            brakeArrow.classList.remove('hidden');
            setTimeout(() => {
                steerLeftArrow.classList.add('hidden');
                steerRightArrow.classList.add('hidden');
                accelArrow.classList.add('hidden');
                brakeArrow.classList.add('hidden');
            }, 2500);
        }

        function enterFullscreen() {
            const elem = document.documentElement;
            if (elem.requestFullscreen) {
                elem.requestFullscreen();
            } else if (elem.mozRequestFullScreen) {
                elem.mozRequestFullScreen();
            } else if (elem.webkitRequestFullscreen) {
                elem.webkitRequestFullscreen();
            } else if (elem.msRequestFullscreen) {
                elem.msRequestFullscreen();
            }
        }

        function createParticles(x, y, color, count) {
            for (let i = 0; i < count; i++) {
                particles.push({
                    x,
                    y,
                    vx: Math.random() * 4 - 2,
                    vy: Math.random() * 4 - 2,
                    life: Math.random() * 30 + 20,
                    color
                });
            }
        }

        function updateParticles(deltaTime) {
            particles.forEach((p, index) => {
                p.x += p.vx * deltaTime / 16.67;
                p.y += p.vy * deltaTime / 16.67;
                p.life -= deltaTime / 16.67;
                if (p.life <= 0) {
                    particles.splice(index, 1);
                }
            });
        }

        function drawParticles() {
            particles.forEach(p => {
                ctx.beginPath();
                ctx.arc(p.x, p.y, 2, 0, Math.PI * 2);
                ctx.fillStyle = p.color;
                ctx.fill();
            });
        }

        // --- Local Storage Functions for Leaderboard ---
        function loadLeaderboard() {
            const leaderboardData = JSON.parse(localStorage.getItem(leaderboardKey)) || [];
            return leaderboardData;
        }

        function saveLeaderboard(leaderboardData) {
            localStorage.setItem(leaderboardKey, JSON.stringify(leaderboardData));
        }

        function clearLeaderboard() {
            localStorage.setItem(leaderboardKey, JSON.stringify([]));
            showLeaderboardScreen();
            showMessage('Leaderboard Cleared!');
        }

        function updateLeaderboard(playerName, lapTime) {
            let leaderboardData = loadLeaderboard();
            const existingEntry = leaderboardData.find(entry => entry.name.toLowerCase() === playerName.toLowerCase());
            
            if (existingEntry) {
                if (lapTime < existingEntry.time) {
                    existingEntry.time = lapTime;
                }
            } else {
                leaderboardData.push({ name: playerName, time: lapTime });
            }
            
            leaderboardData.sort((a, b) => a.time - b.time);
            
            if (leaderboardData.length > 10) {
                leaderboardData = leaderboardData.slice(0, 10);
            }
            
            saveLeaderboard(leaderboardData);
        }
        
        // --- Screens and Flow ---
        function showSplashScreen() {
            splashScreen.classList.remove('hidden');
            instructionsScreen.classList.add('hidden');
            usernameScreen.classList.add('hidden');
            customizationScreen.classList.add('hidden');
            leaderboard.classList.add('hidden');
            mobileControlsDiv.style.display = 'none';
        }

        function showInstructions() {
            splashScreen.classList.add('hidden');
            instructionsScreen.classList.remove('hidden');
            nextToUsernameButton.focus();
            mobileControlsDiv.style.display = 'none';
            if (isMobile) {
                document.getElementById('desktop-site-message').style.display = 'block';
            }
        }
        
        function showUsernameScreen() {
            instructionsScreen.classList.add('hidden');
            usernameScreen.classList.remove('hidden');
            usernameInput.focus();
            mobileControlsDiv.style.display = 'none';
        }

        function showCustomizationScreen() {
            usernameScreen.classList.add('hidden');
            leaderboard.classList.add('hidden');
            customizationScreen.classList.remove('hidden');
            mobileControlsDiv.style.display = 'none';
            drawCarPreview();
        }

        function showLeaderboardScreen() {
            hud.classList.add('hidden');
            leaderboard.classList.remove('hidden');
            mobileControlsDiv.style.display = 'none';
            const leaderboardData = loadLeaderboard();
            leaderboardList.innerHTML = '';
            
            if (leaderboardData.length === 0) {
                const li = document.createElement('li');
                li.textContent = 'No records yet. Be the first!';
                leaderboardList.appendChild(li);
                playerBestTimeDisplay.classList.add('hidden');
            } else {
                leaderboardData.forEach((entry, index) => {
                    const li = document.createElement('li');
                    li.textContent = `${index + 1}. ${entry.name}: ${formatTime(entry.time)}`;
                    if (entry.name.toLowerCase() === currentPlayerName.toLowerCase()) {
                        li.classList.add('current-player');
                        playerBestTimeDisplay.textContent = `Your Best Time: ${formatTime(entry.time)}`;
                        playerBestTimeDisplay.classList.remove('hidden');
                    }
                    if (index === 0) li.classList.add('gold');
                    else if (index === 1) li.classList.add('silver');
                    else if (index === 2) li.classList.add('bronze');
                    else if (index === 3 || index === 4) li.classList.add('blue');
                    leaderboardList.appendChild(li);
                });
            }
        }
        
        function drawCarPreview() {
            carPreviewCtx.clearRect(0, 0, carPreviewCanvas.width, carPreviewCanvas.height);
            carPreviewCtx.save();
            carPreviewCtx.translate(carPreviewCanvas.width / 2, carPreviewCanvas.height / 2);
            carPreviewCtx.rotate(Math.PI / 4);
            drawCar(car, carPreviewCtx, 1.5, true);
            carPreviewCtx.restore();
        }

        // --- Game Setup ---
        function generateTrack() {
            const trackPointsData = [
                { x: 0, y: 0, cp: true },
                { x: 1500, y: 0, cp: false },
                { x: 1800, y: -200, cp: true },
                { x: 2000, y: -500, cp: false },
                { x: 1800, y: -800, cp: true },
                { x: 1400, y: -900, cp: false },
                { x: 1100, y: -800, cp: true },
                { x: 1200, y: -600, cp: false },
                { x: 1100, y: -400, cp: true },
                { x: 900, y: -200, cp: false },
                { x: 700, y: 0, cp: true },
                { x: 800, y: 200, cp: false },
                { x: 700, y: 400, cp: true },
                { x: 500, y: 600, cp: false },
                { x: 300, y: 800, cp: true },
                { x: 0, y: 1000, cp: true },
                { x: -300, y: 900, cp: false },
                { x: -600, y: 700, cp: true },
                { x: -900, y: 400, cp: false },
                { x: -1200, y: 100, cp: true },
                { x: -1000, y: -200, cp: true },
                { x: -900, y: -400, cp: false },
                { x: -1000, y: -600, cp: true },
                { x: -800, y: -800, cp: false },
                { x: -500, y: -900, cp: true },
                { x: -300, y: -700, cp: false },
                { x: -500, y: -500, cp: true },
                { x: -300, y: -300, cp: false },
                { x: -100, y: -100, cp: true },
                { x: 0, y: 0, cp: true }
            ];
            
            trackPath = [];
            checkpoints = [];

            for (let i = 0; i < trackPointsData.length - 1; i++) {
                const p1 = trackPointsData[i];
                const p2 = trackPointsData[i + 1];
                const distance = getDistance(p1.x, p1.y, p2.x, p2.y);
                const segments = Math.max(10, Math.floor(distance / 50));

                for (let j = 0; j < segments; j++) {
                    const t = j / segments;
                    const x = lerp(p1.x, p2.x, t);
                    const y = lerp(p1.y, p2.y, t);
                    trackPath.push({ x, y });
                }
                if (p2.cp) {
                    checkpoints.push({ x: p2.x, y: p2.y, radius: config.trackWidth / 2, passed: false });
                }
            }
        }

        function initGame() {
            onResize();
            generateTrack();
            
            Tone.context.resume().then(() => {
                engineSynth = new Tone.PolySynth(Tone.AMSynth).toDestination();
                engineSynth.set({
                    envelope: { attack: 0.05, decay: 0.2, sustain: 0.5, release: 0.5 },
                    oscillator: { type: 'sawtooth' },
                    modulation: { type: 'sine', frequency: 4 },
                    modulationEnvelope: { attack: 0.1, decay: 0.2, sustain: 0.3, release: 0.5 }
                });
                engineSynth.volume.value = Tone.gainToDb(engineVolume / 100);

                skidSynth = new Tone.NoiseSynth({
                    noise: { type: "white" },
                    envelope: { attack: 0.005, decay: 0.1, sustain: 0, release: 0.1 }
                }).toDestination();

                boostSynth = new Tone.Synth({
                    oscillator: { type: 'triangle' },
                    envelope: { attack: 0.01, decay: 0.2, sustain: 0.5, release: 0.3 }
                }).toDestination();

                clickSynth = new Tone.NoiseSynth({
                    noise: { type: "white" },
                    envelope: { attack: 0.001, decay: 0.05, sustain: 0, release: 0.01 }
                }).toDestination();

                checkpointSynth = new Tone.Synth({
                    oscillator: { type: 'sine' },
                    envelope: { attack: 0.01, decay: 0.1, sustain: 0, release: 0.1 }
                }).toDestination();

                lapCompleteSynth = new Tone.PolySynth(Tone.Synth).toDestination();
            }).catch(console.error);

            window.addEventListener('resize', onResize);
            window.addEventListener('orientationchange', onResize);
            window.addEventListener('keydown', (e) => { 
                keys[e.key.toLowerCase()] = true;
                if (e.key === ' ' && car.boostCooldown <= 0 && gameActive) { 
                    car.isBoosting = true;
                    car.boostTimer = config.boostDuration;
                    car.boostCooldown = config.boostCooldown;
                    showMessage('BOOST!');
                    triggerCameraShake();
                    createParticles(car.x - Math.cos(car.angle) * (config.carHeight / 2), car.y - Math.sin(car.angle) * (config.carHeight / 2), '#ff9900', 20);
                    if (boostSynth) boostSynth.triggerAttackRelease('G4', '8n', Tone.now(), 0.5 * engineVolume / 100);
                }
            });
            window.addEventListener('keyup', (e) => { keys[e.key.toLowerCase()] = false; });
            
            canvas.addEventListener('touchstart', (e) => {
                if (e.touches.length === 2 && car.boostCooldown <= 0 && gameActive) {
                    e.preventDefault();
                    car.isBoosting = true;
                    car.boostTimer = config.boostDuration;
                    car.boostCooldown = config.boostCooldown;
                    showMessage('BOOST!');
                    triggerCameraShake();
                    createParticles(car.x - Math.cos(car.angle) * (config.carHeight / 2), car.y - Math.sin(car.angle) * (config.carHeight / 2), '#ff9900', 20);
                    if (boostSynth) boostSynth.triggerAttackRelease('G4', '8n', Tone.now(), 0.5 * engineVolume / 100);
                }
            }, { passive: false });

            enterGameButton.addEventListener('pointerdown', (e) => {
                e.preventDefault();
                splashScreen.classList.add('hidden');
                showInstructions();
                if (clickSynth) clickSynth.triggerAttackRelease("8n", Tone.now(), 0.05 * engineVolume / 100);
            });

            nextToUsernameButton.addEventListener('pointerdown', (e) => {
                e.preventDefault();
                showUsernameScreen();
                if (clickSynth) clickSynth.triggerAttackRelease("8n", Tone.now(), 0.05 * engineVolume / 100);
            });
            
            saveUsernameButton.addEventListener('pointerdown', (e) => {
                e.preventDefault();
                const username = usernameInput.value.trim();
                const leaderboardData = loadLeaderboard();
                if (username.length < 8 || username.length > 16) {
                    usernameError.textContent = 'Username must be between 8 and 16 characters.';
                    usernameError.classList.remove('hidden');
                } else if (!/^[a-zA-Z0-9]+$/.test(username)) {
                    usernameError.textContent = 'Username must contain only letters and numbers.';
                    usernameError.classList.remove('hidden');
                } else if (leaderboardData.some(p => p.name.toLowerCase() === username.toLowerCase())) {
                    usernameError.textContent = 'Username already taken. Choose a different one.';
                    usernameError.classList.remove('hidden');
                } else {
                    usernameScreen.classList.add('hidden');
                    usernameError.classList.add('hidden');
                    localStorage.setItem('turboGPUsername', username);
                    currentPlayerName = username;
                    showCustomizationScreen();
                    if (clickSynth) clickSynth.triggerAttackRelease("8n", Tone.now(), 0.05 * engineVolume / 100);
                }
            });

            startButton.addEventListener('pointerdown', (e) => {
                e.preventDefault();
                startGame();
                if (isMobile) {
                    showArrowIndicators();
                }
                if (clickSynth) clickSynth.triggerAttackRelease("8n", Tone.now(), 0.05 * engineVolume / 100);
            });

            retryButton.addEventListener('pointerdown', (e) => {
                e.preventDefault();
                leaderboard.classList.add('hidden');
                showCustomizationScreen();
                if (clickSynth) clickSynth.triggerAttackRelease("8n", Tone.now(), 0.05 * engineVolume / 100);
            });

            checkLeaderboardButton.addEventListener('pointerdown', (e) => {
                e.preventDefault();
                showLeaderboardScreen();
                if (clickSynth) clickSynth.triggerAttackRelease("8n", Tone.now(), 0.05 * engineVolume / 100);
            });

            clearLeaderboardButton.addEventListener('pointerdown', (e) => {
                e.preventDefault();
                if (confirm('Are you sure you want to clear the leaderboard? This cannot be undone.')) {
                    clearLeaderboard();
                    if (clickSynth) clickSynth.triggerAttackRelease("8n", Tone.now(), 0.05 * engineVolume / 100);
                }
            });

            carStyleButtons.forEach(button => {
                button.addEventListener('pointerdown', (e) => {
                    e.preventDefault();
                    carStyleButtons.forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    car.style = e.target.dataset.style;
                    drawCarPreview();
                    if (clickSynth) clickSynth.triggerAttackRelease("8n", Tone.now(), 0.05 * engineVolume / 100);
                });
            });

            steeringSensitivityInput.addEventListener('input', () => {
                car.steeringSensitivity = parseFloat(steeringSensitivityInput.value);
                sensitivityValueDisplay.textContent = car.steeringSensitivity.toFixed(2);
                const percentage = ((car.steeringSensitivity - 0.1) / (4.0 - 0.1)) * 100;
                sensitivityBarFill.style.width = `${percentage}%`;
            });

            engineVolumeInput.addEventListener('input', () => {
                engineVolume = parseInt(engineVolumeInput.value);
                volumeValueDisplay.textContent = engineVolume;
                localStorage.setItem('turboGPEngineVolume', engineVolume);
                if (engineSynth) {
                    engineSynth.volume.value = Tone.gainToDb(engineVolume / 100);
                }
            });

            volumeValueDisplay.textContent = engineVolume;
            engineVolumeInput.value = engineVolume;

            // Initialize sensitivity bar
            const percentage = ((car.steeringSensitivity - 0.1) / (4.0 - 0.1)) * 100;
            sensitivityBarFill.style.width = `${percentage}%`;

            document.getElementById('steerLeft').addEventListener('pointerdown', (e) => {
                e.preventDefault();
                mobileControls.left = true;
                if (clickSynth) clickSynth.triggerAttackRelease("8n", Tone.now(), 0.05 * engineVolume / 100);
            }, { passive: false });
            document.getElementById('steerLeft').addEventListener('pointerup', () => {
                mobileControls.left = false;
            });
            document.getElementById('steerRight').addEventListener('pointerdown', (e) => {
                e.preventDefault();
                mobileControls.right = true;
                if (clickSynth) clickSynth.triggerAttackRelease("8n", Tone.now(), 0.05 * engineVolume / 100);
            }, { passive: false });
            document.getElementById('steerRight').addEventListener('pointerup', () => {
                mobileControls.right = false;
            });
            document.getElementById('accelButton').addEventListener('pointerdown', (e) => {
                e.preventDefault();
                mobileControls.accel = true;
                if (clickSynth) clickSynth.triggerAttackRelease("8n", Tone.now(), 0.05 * engineVolume / 100);
            }, { passive: false });
            document.getElementById('accelButton').addEventListener('pointerup', () => {
                mobileControls.accel = false;
            });
            document.getElementById('brakeButton').addEventListener('pointerdown', (e) => {
                e.preventDefault();
                mobileControls.brake = true;
                if (clickSynth) clickSynth.triggerAttackRelease("8n", Tone.now(), 0.05 * engineVolume / 100);
            }, { passive: false });
            document.getElementById('brakeButton').addEventListener('pointerup', () => {
                mobileControls.brake = false;
            });

            showSplashScreen();
            requestAnimationFrame(gameLoop);
        }

        function startGame() {
            customizationScreen.classList.add('hidden');
            hud.classList.remove('hidden');
            if (isMobile) {
                mobileControlsDiv.style.display = 'flex';
            }
            resetGame();
            lapStartTime = performance.now();
            gameActive = true;
            car.lapTimes = [];
            requestAnimationFrame(updateTime);
        }

        function resetGame() {
            car.x = trackPath[0].x;
            car.y = trackPath[0].y;
            car.angle = 0;
            car.speed = 0;
            car.isBoosting = false;
            car.boostTimer = 0;
            car.boostCooldown = 0;
            boostTrail = [];
            tireMarks.length = 0;
            particles.length = 0;
            
            currentLap = 0;
            checkpointIndex = 0;
            checkpoints.forEach(cp => cp.passed = false);
            lapStartTime = null;
            updateHUD();
        }

        function onResize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            camera.x = car.x - canvas.width / 2;
            camera.y = car.y - canvas.height / 2;
        }
        
        function updateTime(timestamp) {
            if (gameActive) {
                lapTimeDisplay.textContent = formatTime(performance.now() - lapStartTime);
                animationFrameId = requestAnimationFrame(updateTime);
            }
        }

        // --- Main Game Loop ---
        function gameLoop(timestamp) {
            const deltaTime = timestamp - lastTimestamp || 16.67;
            lastTimestamp = timestamp;

            if (gameActive) {
                updatePlayer(deltaTime);
            }
            
            updateParticles(deltaTime);
            draw();

            requestAnimationFrame(gameLoop);
        }

        // --- Update Logic ---
        function updatePlayer(deltaTime) {
            if (car.isBoosting) {
                car.boostTimer -= deltaTime;
                if (car.boostTimer <= 0) {
                    car.isBoosting = false;
                }
                boostTrail.push({ x: car.x, y: car.y, alpha: 1.0 });
                if (boostTrail.length > config.boostTrailLength) {
                    boostTrail.shift();
                }
            }
            if (car.boostCooldown > 0) {
                car.boostCooldown -= deltaTime;
            }

            let currentMaxSpeed = car.isBoosting ? config.boostSpeed : config.maxSpeed;
            
            if (keys['w'] || keys['arrowup'] || mobileControls.accel) {
                car.speed += config.acceleration;
            } else if (keys['s'] || keys['arrowdown'] || mobileControls.brake) {
                car.speed -= config.acceleration * 2;
            }
            
            car.speed = Math.min(Math.max(car.speed, -currentMaxSpeed / 2), currentMaxSpeed);
            car.speed *= config.friction;

            const steeringFactor = Math.min(1, Math.abs(car.speed) / currentMaxSpeed * 0.2); // Adjusted for higher speeds
            if (Math.abs(car.speed) > 0.1) {
                const prevAngle = car.angle;
                const adjustedRotationSpeed = config.baseRotationSpeed * car.steeringSensitivity * (1 - steeringFactor);
                if (keys['a'] || keys['arrowleft'] || mobileControls.left) {
                    car.angle -= adjustedRotationSpeed;
                } else if (keys['d'] || keys['arrowright'] || mobileControls.right) {
                    car.angle += adjustedRotationSpeed;
                }

                if (skidSynth && Math.abs(car.angle - prevAngle) > 0.015 * car.steeringSensitivity && Math.abs(car.speed) > 2) {
                    tireMarks.push({ x: car.x, y: car.y });
                    if (tireMarks.length > config.maxTireMarks) {
                        tireMarks.shift();
                    }
                    skidSynth.triggerAttackRelease("4n", Tone.now(), 0.1 * engineVolume / 100);
                    createParticles(car.x, car.y, 'gray', 5);
                }
            }

            car.x += Math.cos(car.angle) * car.speed;
            car.y += Math.sin(car.angle) * car.speed;

            const targetCamX = car.x - canvas.width / 2;
            const targetCamY = car.y - canvas.height / 2;
            camera.x = lerp(camera.x, targetCamX, 0.1);
            camera.y = lerp(camera.y, targetCamY, 0.1);

            if (engineSynth) {
                const speedRatio = Math.abs(car.speed) / currentMaxSpeed;
                const pitch = 200 + speedRatio * 1500;
                engineSynth.set({ detune: pitch });
                if (speedRatio > 0.1 && Tone.context.state === 'running') {
                    if (!engineSynth.isPlaying) {
                        engineSynth.triggerAttack('C4');
                        engineSynth.isPlaying = true;
                    }
                } else {
                    if (engineSynth.isPlaying) {
                        engineSynth.triggerRelease();
                        engineSynth.isPlaying = false;
                    }
                }
            }
            
            checkCollisions();
            updateHUD();
        }
        
        function checkCollisions() {
            const currentCheckpoint = checkpoints[checkpointIndex];
            const distToCheckpoint = getDistance(car.x, car.y, currentCheckpoint.x, currentCheckpoint.y);

            if (distToCheckpoint < currentCheckpoint.radius && !currentCheckpoint.passed) {
                currentCheckpoint.passed = true;
                checkpointIndex++;
                triggerFlash();
                showMessage('Checkpoint Reached!');
                triggerCameraShake();
                createParticles(car.x, car.y, '#00ff00', 10);
                if (checkpointSynth) checkpointSynth.triggerAttackRelease('C5', '8n', Tone.now(), 0.5 * engineVolume / 100);
                if (checkpointIndex >= checkpoints.length) {
                    currentLap++;
                    const lapTime = performance.now() - lapStartTime;
                    cancelAnimationFrame(animationFrameId);
                    showMessage(`Fastest Lap: ${formatTime(lapTime)}`);
                    updateLeaderboard(currentPlayerName, lapTime);
                    gameActive = false;
                    if (lapCompleteSynth) lapCompleteSynth.triggerAttackRelease(['C4', 'E4', 'G4'], '4n', Tone.now(), 0.5 * engineVolume / 100);
                    setTimeout(showLeaderboardScreen, 2500);
                }
            }
            
            const distFromTrackCenter = Math.min(...trackPath.map(p => getDistance(car.x, car.y, p.x, p.y)));
            if (distFromTrackCenter > config.trackWidth / 2 + 10) {
                car.speed *= 0.5;
                createParticles(car.x, car.y, 'brown', 8);
            }
        }
        
        function updateHUD() {
            const speedRatio = Math.abs(car.speed) / config.maxSpeed;
            speedDisplay.textContent = Math.round(speedRatio * 120); // Adjusted for higher max speed
            if (car.boostCooldown > 0) {
                boostDisplay.textContent = `COOLDOWN: ${(car.boostCooldown / 1000).toFixed(1)}s`;
            } else if (car.isBoosting) {
                boostDisplay.textContent = `BOOSTING: ${(car.boostTimer / 1000).toFixed(1)}s`;
            } else {
                boostDisplay.textContent = 'BOOST: READY';
            }
        }

        // --- Drawing Logic ---
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            let camX = camera.x;
            let camY = camera.y;
            
            if (camera.shakeTime > 0) {
                camX += Math.random() * config.cameraShakeIntensity - config.cameraShakeIntensity / 2;
                camY += Math.random() * config.cameraShakeIntensity - config.cameraShakeIntensity / 2;
                camera.shakeTime -= 16.67;
            }
            
            ctx.save();
            ctx.translate(-camX, -camY);

            drawBackground();
            drawTrack();
            drawZones();
            drawBoostTrail();
            drawTireMarks();
            drawCar(car, ctx, 1);
            drawParticles();
            if (gameActive && checkpointIndex < checkpoints.length) {
                drawCheckpointArrow();
            }

            ctx.restore();

            drawHUD();
        }

        function drawBackground() {
            ctx.fillStyle = '#1e8449';
            ctx.fillRect(camera.x, camera.y, canvas.width, canvas.height);

            ctx.fillStyle = '#2ecc71';
            ctx.fillRect(camera.x - 2000, camera.y - 2000, 4000, 4000);
            ctx.fillStyle = '#1e8449';
            trackPath.forEach((p, i) => {
                ctx.beginPath();
                ctx.arc(p.x, p.y, config.trackWidth * 1.5, 0, Math.PI * 2);
                ctx.fill();
            });
        }

        function drawTrack() {
            ctx.beginPath();
            ctx.strokeStyle = '#145a32';
            ctx.lineWidth = config.trackWidth + 40;
            ctx.lineJoin = 'round';
            for (let i = 0; i < trackPath.length; i++) {
                if (i === 0) ctx.moveTo(trackPath[i].x, trackPath[i].y);
                else ctx.lineTo(trackPath[i].x, trackPath[i].y);
            }
            ctx.stroke();

            ctx.beginPath();
            ctx.strokeStyle = '#2c3e50';
            ctx.lineWidth = config.trackWidth;
            ctx.lineJoin = 'round';
            for (let i = 0; i < trackPath.length; i++) {
                if (i === 0) ctx.moveTo(trackPath[i].x, trackPath[i].y);
                else ctx.lineTo(trackPath[i].x, trackPath[i].y);
            }
            ctx.stroke();

            ctx.beginPath();
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 5;
            ctx.lineJoin = 'round';
            for (let i = 0; i < trackPath.length; i++) {
                if (i === 0) ctx.moveTo(trackPath[i].x, trackPath[i].y);
                else ctx.lineTo(trackPath[i].x, trackPath[i].y);
            }
            ctx.stroke();

            ctx.lineWidth = 20;
            ctx.lineCap = 'square';
            for (let i = 0; i < trackPath.length - 1; i++) {
                const p1 = trackPath[i];
                const p2 = trackPath[i + 1];
                const angle = Math.atan2(p2.y - p1.y, p2.x - p1.x);
                const dist = getDistance(p1.x, p1.y, p2.x, p2.y);
                const segments = Math.floor(dist / 20);

                for (let j = 0; j < segments; j++) {
                    const t = j / segments;
                    const x = lerp(p1.x, p2.x, t);
                    const y = lerp(p1.y, p2.y, t);
                    ctx.beginPath();
                    ctx.strokeStyle = j % 2 === 0 ? '#c0392b' : '#fff';
                    ctx.moveTo(x, y);
                    const nextT = (j + 1) / segments;
                    const nextX = lerp(p1.x, p2.x, nextT);
                    const nextY = lerp(p1.y, p2.y, nextT);
                    ctx.lineTo(nextX, nextY);
                    ctx.stroke();
                }
            }

            const startPoint = trackPath[0];
            const nextPoint = trackPath[1];
            const angle = Math.atan2(nextPoint.y - startPoint.y, nextPoint.x - startPoint.x);
            
            ctx.save();
            ctx.translate(startPoint.x, startPoint.y);
            ctx.rotate(angle);
            
            const lineLength = config.trackWidth;
            const lineSegment = lineLength / 10;
            for (let i = 0; i < 10; i++) {
                ctx.fillStyle = (i % 2 === 0) ? '#000' : '#fff';
                ctx.fillRect(i * lineSegment - lineLength / 2, -5, lineSegment, 10);
            }
            ctx.restore();

            ctx.fillStyle = '#7f8c8d';
            ctx.fillRect(100, -50, 200, 50);
            ctx.fillRect(-1100, 50, 200, 50);
            ctx.fillStyle = '#ecf0f1';
            for (let i = 0; i < 5; i++) {
                ctx.fillRect(110, -40 + i * 10, 180, 5);
                ctx.fillRect(-1090, 60 + i * 10, 180, 5);
            }
        }

        function drawZones() {
            checkpoints.forEach((cp, index) => {
                ctx.beginPath();
                ctx.arc(cp.x, cp.y, cp.radius, 0, 2 * Math.PI);
                ctx.strokeStyle = '#f39c12';
                ctx.lineWidth = 5;
                ctx.globalAlpha = 0.5;
                if (cp.passed) {
                    ctx.strokeStyle = '#2ecc71';
                }
                ctx.stroke();
                ctx.globalAlpha = 1;
            });
        }

        function drawCheckpointArrow() {
            const currentCheckpoint = checkpoints[checkpointIndex];
            const dx = currentCheckpoint.x - car.x;
            const dy = currentCheckpoint.y - car.y;
            const angle = Math.atan2(dy, dx);
            const arrowLength = config.arrowSize;
            const arrowWidth = arrowLength / 2;
            const offsetX = Math.cos(car.angle) * (config.carHeight / 2 + 40);
            const offsetY = Math.sin(car.angle) * (config.carHeight / 2 + 40);

            ctx.save();
            ctx.translate(car.x + offsetX, car.y + offsetY);
            ctx.rotate(angle);
            ctx.beginPath();
            ctx.moveTo(0, -arrowWidth);
            ctx.lineTo(arrowLength, 0);
            ctx.lineTo(0, arrowWidth);
            ctx.closePath();
            ctx.fillStyle = 'rgba(46, 204, 113, 0.7)';
            ctx.fill();
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 2;
            ctx.stroke();
            ctx.restore();
        }
        
        function drawBoostTrail() {
            if (boostTrail.length > 0) {
                ctx.beginPath();
                ctx.strokeStyle = 'rgba(255, 165, 0, 0.8)';
                ctx.lineWidth = 10;
                ctx.globalAlpha = 0.5;
                ctx.moveTo(boostTrail[0].x, boostTrail[0].y);
                for (let i = 1; i < boostTrail.length; i++) {
                    ctx.globalAlpha = boostTrail[i].alpha * 0.5;
                    ctx.lineTo(boostTrail[i].x, boostTrail[i].y);
                    boostTrail[i].alpha -= 0.05;
                }
                ctx.stroke();
                ctx.globalAlpha = 1;
                boostTrail = boostTrail.filter(point => point.alpha > 0);
            }
        }
        
        function drawTireMarks() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            tireMarks.forEach(mark => {
                ctx.beginPath();
                ctx.arc(mark.x, mark.y, 3, 0, Math.PI * 2);
                ctx.fill();
            });
        }
        
        function drawCar(carToDraw, context, scale, isPreview = false) {
            context.save();
            if (!isPreview) {
                context.translate(carToDraw.x, carToDraw.y);
                context.rotate(carToDraw.angle);
            }
            context.scale(scale, scale);
            
            const carWidth = config.carWidth;
            const carHeight = config.carHeight;
            const boostFactor = carToDraw.isBoosting ? 1.2 : 1;
            
            let carImage = carImages[carToDraw.style] || carImages.sedan;

            if (carImage.complete && carImage.naturalWidth !== 0) {
                if (carToDraw.style === 'porsche' || carToDraw.style === 'sports') {
                    context.scale(-1, 1);
                }
                if (carToDraw.style === 'sedan' || carToDraw.style === 'pickup') {
                    context.drawImage(carImage, -carHeight / 2, -carWidth / 2, carHeight, carWidth);
                } else {
                    context.drawImage(carImage, -carHeight / 2, -carWidth / 2, carHeight, carWidth);
                }
            } else {
                context.fillStyle = '#E74C3C';
                context.fillRect(-carHeight / 2, -carWidth / 2, carHeight, carWidth);
                context.strokeStyle = '#000000';
                context.lineWidth = 2;
                context.strokeRect(-carHeight / 2, -carWidth / 2, carHeight, carWidth);
            }

            context.restore();
        }

        function drawHUD() {
            const minimapWidth = 150;
            const minimapHeight = 100;
            const minimapX = canvas.width - minimapWidth - 10;
            const minimapY = canvas.height - minimapHeight - 10;
            const trackBounds = {
                minX: Math.min(...trackPath.map(p => p.x)),
                maxX: Math.max(...trackPath.map(p => p.x)),
                minY: Math.min(...trackPath.map(p => p.y)),
                maxY: Math.max(...trackPath.map(p => p.y))
            };
            const trackWidth = trackBounds.maxX - trackBounds.minX;
            const trackHeight = trackBounds.maxY - trackBounds.minY;
            const scaleX = minimapWidth / trackWidth;
            const scaleY = minimapHeight / trackHeight;
            const scale = Math.min(scaleX, scaleY) * 0.8;

            ctx.save();
            ctx.translate(minimapX, minimapY);
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(0, 0, minimapWidth, minimapHeight);

            ctx.beginPath();
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 2;
            for (let i = 0; i < trackPath.length; i++) {
                const x = (trackPath[i].x - trackBounds.minX) * scale;
                const y = (trackPath[i].y - trackBounds.minY) * scale;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();

            checkpoints.forEach(cp => {
                ctx.beginPath();
                ctx.arc((cp.x - trackBounds.minX) * scale, (cp.y - trackBounds.minY) * scale, 3, 0, Math.PI * 2);
                ctx.fillStyle = cp.passed ? '#2ecc71' : '#f39c12';
                ctx.fill();
            });

            const carX = (car.x - trackBounds.minX) * scale;
            const carY = (car.y - trackBounds.minY) * scale;
            ctx.save();
            ctx.translate(carX, carY);
            ctx.rotate(car.angle);
            ctx.fillStyle = '#E74C3C';
            ctx.fillRect(-5, -3, 10, 6);
            ctx.restore();

            ctx.restore();

            const tachWidth = 100;
            const tachHeight = 10;
            const tachX = 10;
            const tachY = canvas.height - tachHeight - 10;
            const speedRatio = Math.abs(car.speed) / config.maxSpeed;
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(tachX, tachY, tachWidth, tachHeight);
            ctx.fillStyle = speedRatio > 0.8 ? '#e74c3c' : '#2ecc71';
            ctx.fillRect(tachX, tachY, tachWidth * speedRatio, tachHeight);
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 1;
            ctx.strokeRect(tachX, tachY, tachWidth, tachHeight);
        }

        initGame();
    </script>
</body>
</html>